Module 10

Lab: Implementing Directory Synchronization
-------------------------------------------

Scenario

Lucerne Publishing is beginning to realize that cloud-based user and group management in Office 365 is failing to meet the organization's needs. Users are forgetting passwords, and helpdesk calls are up 68 percent. As a result, the company is anxious to investigate DirSync and password synchronization for user and group management.

Objectives

To provide the students with practical experience of planning and deploying DirSync.

Lab Setup

Estimated Time: 120 minutes

Virtual machine: 20346C-LUC-CL1

Username: **Student1**

Password: **Pa$$w0rd**

In all tasks, where you see references to lucernepublishingXXXX.onmicrosoft.com, replace the XXXX with the unique Lucerne Publishing number that you were assigned when you set up your Office 365 account in Module 1, Lab 1B, Exercise 2, Task 3, Step 5.

Where you see references to labXXXXX.o365ready.com, replace the XXXXX with the unique o365ready.com number you were assigned when you registered your IP address at www.o365ready.com in Module 2, Lab 2B, Exercise 1, Task 2, Step 6.

### Exercise 1: Prepare on-premises Active Directory for DirSync

Scenario

Over the last few weeks, it has been particularly obvious that, as predicted by Alain Richer, cloud-based user and group management simply isn’t working. The company needs to move to a different model for organizing users and groups between its on-premises and cloud-based environments. As a result, the deployment team has been analyzing DirSync functionality and the option of Password Sync. Before this deployment can proceed, there are several checks that the team needs to run; these include looking for duplicate accounts, filtering the directory, and correcting UPNs.

The main tasks for this exercise are as follows:

1. Prepare Problem User Accounts

2. Remediate AD Errors with IDFix

3. Remediate AD Errors with ADModify

4. Activate Directory Synchronization

5. Create an Enterprise Administrator Account for Use in DirSync Setup

####   Task 1: Prepare Problem User Accounts

1.  On your host computer, switch to the **20346C-LUC-CL1** virtual machine.

Ensure you are logged on as **Student1** with a password of **Pa$$word**.

On the **LUC-CL1** computer, on the Desktop, on the Taskbar, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-EX1.rdp**, and connect as **LUCERNE\\LucAdmin**, password: **Pa$$w0rd**.

On the Start screen, type **PowerShell**.

Right-click **Windows PowerShell**, and then click **Run as administrator**.

At the Windows PowerShell prompt, type the following command, and press Enter:

CD C:\\Temp

At the Windows PowerShell prompt, type the following command, and press Enter:

Set-ExecutionPolicy Unrestricted

Press Enter to confirm the execution policy change.

At the Windows PowerShell prompt, type the following command, and press Enter:

.\\CreateProblemUsers.ps1

In **LUC-CL1**, double-click on **E:\\RDPFiles\\LUC-DC1.rdp** and log on as **LUCERNE\\LucAdmin**, password: **Pa$$w0rd**.

In **Server Manager**, click **Tools**, and then click **ADSI Edit**.

In **ADSI Edit**, in the navigation pane, right-click **ADSI Edit**, and click **Connect to**.

In the **Connection Settings** dialog box, click **OK**.

In the navigation pane, expand **Default** **naming** **context**, then expand **DC=lucernepublishing,DC=local**, and then click **OU=Engineering**.

In the **Results** pane, right-click **dshivers**, and then click **Properties**.

In the **Properties** dialog box, in the **Attributes** list, select **userPrincipalName**, and then click **Edit**.

In the **String Attribute Editor**, add a "**|**" character in front of "**lucerne**", and click **OK**.

Click **OK**, to close the Properties dialog box.

In the **Results** pane, right-click **kfredrickson**, and then click **Properties**.

In the **Properties** dialog box, in the **Attributes** list, select **mailnickname**, and then click **Edit**.

In the **String Attribute Editor**, replace the existing string with "**duplicate**", and click **OK**.

Click **OK**, to close the Properties dialog box.

In the **Results** pane, right-click **bhowerton**, and then click **Properties**.

In the **Properties** dialog box, in the **Attributes** list, select **mailnickname**, and then click **Edit**.

In the **String Attribute Editor**, replace the existing string with "**duplicate**", and click **OK**.

Click **OK**, to close the Properties dialog box.

In the **Results** pane, right-click **gdonato**, and then click **Properties**.

In the **Properties** dialog box, in the **Attributes** list, select **mailnickname**, and then click **Edit**.

In the **String Attribute Editor**, add quote marks around the existing string, and click **OK**.

Click **OK**, to close the Properties dialog box.

In the **Results** pane, right-click **bbeach**, and then click **Properties**.

In the **Properties** dialog box, in the **Attributes** list, select **mailnickname**, and then click **Edit**.

In the **String Attribute Editor**, replace the existing string with a single space, and click **OK**.

Click **OK**, to close the Properties dialog box.

####   Task 2: Remediate AD Errors with IDFix

1.  Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-CL2.rdp**, and connect as **LUCERNE\\LucAdmin**, password: **Pa$$w0rd**.

On the Start screen, click **Computer**.

Navigate to **\\\\LUC-DC1\\C$\\Labfiles\\Lab10**, and double-click **IdFix**.
**Note:** When connecting to **LUC-DC1**, Microsoft’s testing has, on rare occasions, received a message asking if you want to install updates. Do NOT install updates if such a message appears.

If an **Open File – Security Warning** dialog box appears, click **Run**.

In the **WinZip Self-Extractor** dialog box, click **Unzip**, click **OK**, and then click **Close**.

In File Explorer, navigate to **C:\\Deployment Tools\\IdFix**, then right-click **IdFix**, and click **Run as administrator**.

In the **IdFix Privacy Statement** message box, click **OK**.

Click **Query**. You should see a number of errors, which may vary per student.

Click the **ERROR** column to bring the character errors to the top.
**Note:** Ignore **topleveldomain** errors, which cannot be fixed by the IdFix tool.

For each distinguished name that includes a character error, in the **ACTION** column, select **EDIT**; there should be three objects to select.

On the toolbar, click **Apply**.

In the **Apply Pending** dialog box, click **Yes**; note the **COMPLETE** status in the **ACTION** column indicating successful writes.

Switch to **File Explorer**, and in the **C:\\Deployment Tools\\IdFix** folder, double-click **Verbose \<date\> \<time\>.txt**, to view the updated transactions in the transaction log.

Switch back to **IdFix**.

On the toolbar, click **Query**.

Note that one of your fixes has introduced a new error (the **mailnickname** now has brackets).

Click in the **UPDATE** column for the **Beverley Beach** error, and replace the string with **bbeach**, to meet the requirements for this string (initial+surname), and then in the **ACTION** column, select **EDIT**.

Click in the **UPDATE** column for the **Kelly Fredrickson** error, and replace the string with **kfredrickson**, to meet the requirements for this string (initial+surname), and then in the **ACTION** column, select **EDIT**.

Click in the **UPDATE** column for the **Bobby Howerton** error, and replace the string with **bhowerton**, to meet the requirements for this string (initial+surname), and then in the **ACTION** column, select **EDIT**.

On the toolbar, click **Apply**.

In the **Apply Pending** box, click **Yes**.

On the toolbar, click **Query**; the only remaining errors apply to multiple users, and IdFix cannot suggest a fix.

Note the results:

> dshivers = | in userPrincipalName generates character error, idfix can fix this.
>
> gdonato = "mailnickname" generates character error, idfix can fix this.
>
> bbeach = space for mailnickname generates character error, idfix can fix this.
>
> All users = format error on proxyAddresses and userPrincipalName contains @local.

####   Task 3: Remediate AD Errors with ADModify

1.  Press the Windows key to go to the Start screen.

On the Windows Start screen, right-click **Windows PowerShell**, and then click **Run as administrator**.

If you get a **User Account Control** dialog box, click **Yes**.

At the **Windows PowerShell** prompt, type the following command, and press Enter:

Set-ExecutionPolicy Unrestricted

Press Enter to confirm the execution policy change.

At the Windows PowerShell prompt, type the following command, and press Enter:

Add-WindowsFeature NET-Framework-Core -Source C:\\Windows\\WinSxS

Wait for the installation to complete, which may take about 10 minutes.

On **LUC-CL2**, on the Task Bar, click **File Explorer**.

Navigate to **\\\\LUC-DC1\\C$\\Labfiles\\Lab10**, and right-click **ADModify\_2.1**, and then click **Extract All**.

In the **Extract Compressed (Zipped) Folders** dialog box, click **Browse**, and navigate to **C:\\Users\\LucAdmin\\My Documents**.

Click **OK**.

In the **Extract Compressed (Zipped) Folders** dialog box, click **Extract**.

In **My Documents**, right-click **ADModify**, and click **Run as administrator**.

In **ADModify.NET**, click **Modify Attributes**.

Click in the **Domain List**, and select **DC=lucernepublishing,DC=local**.

Click in the **Domain** **Controller** **List**, and select **LUC-DC1.lucernepublishing.local**, and then click the right arrow.

In the **Domain Tree List**, click **lucernepublishing**, then click **+**, then select **Engineering**, and then click **Add To List**.

In the **Results** pane, select all the objects, and then click **Next**.

In the **ADModify.NET** dialog box, click the **Account** tab.

Select the **UPN** check box, then click **Legacy Account**, and then in the UPN list, select your lab UPN in the form **labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number).

Click the **E-Mail Addresses** tab.

Select the **Add SMTP Address** check box.

In the text box, replace the existing string with **%'userPrincipalName'%**.

Select the **Set as Primary** check box.

Select the **Remove E-Mail Address** check box.

In the text box, replace the existing string with **smtp:\*@\*lucernepublishing.local**.

Click **Go**.

In the dialog box, note the name of the results XML file, and then click **OK**.

In **File Explorer**, double-click the results XML file you noted above, to view the results in Internet Explorer.

Close Internet Explorer.

On **LUC-CL2,** switch to **IdFix**.

On the toolbar, click **Query**; the accounts that you fixed should no longer appear.

Close IdFix.

####   Task 4: Activate Directory Synchronization

1.  Switch to the **LUC-CL1** virtual machine session.

Press the Windows key to go to the Start screen.

On the Windows Start screen, right-click Windows Azure Active Directory Module for Windows PowerShell, and then click Run as administrator.

In the **User Account Control** dialog box, click **Yes**.

At the **Windows Azure Active Directory Module for Windows PowerShell** prompt, type the following command, and press Enter:

Set-ExecutionPolicy Unrestricted

Press Enter to confirm the execution policy change.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

$msolcred = Get-Credential

In the **Windows PowerShell Credential** dialog box, enter **hleitner@labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number) in the **User name** box, enter **Pa$$w0rd** in the **Password** box, and then click **OK**.

At the **Windows Azure Active Directory Module for Windows PowerShell** prompt, type the following command, and press Enter:

Connect-MsolService -Credential $msolcred

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Set-MsolDirSyncEnabled -EnableDirSync $true -Force

**Note**: The *-Force* switch disables the confirmation dialog box.

Although you may have to wait up to 24 hours for activation to complete, you should be able to continue.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

(Get-MsolCompanyInformation).DirectorySynchronizationEnabled

The output returns “**True**” if sync is enabled.

Switch to Internet Explorer, and in the address box, type **http://portal.microsoftonline.com**, and press Enter.

On the **Sign** page, in the **Name** box, type **hleitner@labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number). In the **Password** box, type **Pa$$w0rd**, and then click **Sign in**.

In the **Office 365 admin center**, in the left navigation, click **Users**, and then click **Active users.**

To the right of **Active Directory synchronization**, verify that there is a **Deactivate** link (if activation was not yet completed, this link would say “Activate”).

####   Task 5: Create an Enterprise Administrator Account for Use in DirSync Setup

1.  Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-DC1.rdp**, and connect as **LUCERNE\\LucAdmin**, password: **Pa$$w0rd**.

On **LUC-DC1**, in **Server Manager**, click **Tools**, and then click **Active Directory Users and Computers**.

In the console tree, expand **lucernepublishing.local**, right-click **Users**, point to **New**, and then click **User**.

In the **Full** **name** and **User** **logon** **name** boxes, type **dirsync-admin**, and then click **Next**.

In the **Password** and **Confirm** **password** boxes, type **Pa$$w0rd**, clear the **User must change password at next logon** check box, select the **Password never expires** check box, and then click **Next**, and then click **Finish**.

In **Active Directory Users and Computers**, expand **Users**, and then double-click **dirsync-admin.**

In **dirsync-admin Properties**, click the **Member Of** tab, and then click **Add**.

In the **Select Groups** dialog box, in the **Enter the object names to select** box, type the following group names: **domain admins; enterprise admins**

Click **Check Names.**

Click **OK** to close the **Select Groups** dialog box.

Click **OK** to close the dirsync-admin Properties dialog box.

**Results**: At the end of this exercise, the implementation of DirSync can now proceed at Lucerne Publishing. Specifically, any accounts in Active Directory that will prevent synchronization have been identified, directory filtering has been applied, UPNs corrected, and the Enterprise Administrator account recreated.

### Exercise 2: Set up DirSync

Scenario

With all the problem user accounts identified, Lucerne Publishing is ready to install DirSync and run its first directory synchronization. The company has decided to start with just DirSync, and once the on-premises directory has successfully synchronized, it will then enable password synchronization.

The main tasks for this exercise are as follows:

1. Download and Install DirSync

2. Install Windows Azure Active Directory Module for Windows PowerShell

3. Configure DirSync

4. Perform Initial Synchronization

5. Implement Password Synchronization

6. Verify Password Synchronization

####   Task 1: Download and Install DirSync

1.  On **LUC-DC1**, in **Server Manager**, in the navigation pane, click **Local Server**.

In the Properties for **LUC-DC1**, next to **IE Enhanced Security Configuration**, click **On**.

In the **Internet Explorer Enhanced Security Configuration** dialog box, select **Off** for **Administrators**, and then click **OK**.

Close Server Manager.

On **LUC-DC1**, press the Windows key, to go to the Start screen.

On the Windows Start screen, click **Internet Explorer**.

If you get a **Windows Internet Explorer 10** dialog box, select **Use recommended security and compatibility settings**, and then click **OK**.

In the **Address** box, type **http://portal.microsoftonline.com**, and press Enter.

On the **Sign** page, in the **Name** box, type **hleitner@labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number).

In the **Password** box, type **Pa$$w0rd**, and then click **Sign in**.

In the **Office 365 admin center**, in the left navigation, click **Users**, and then click **Active users**.

**Note**: If you see the ***Active Directory synchronization is being activated*** warning banner, you can ignore it at this time, but you will not be able to run directory synchronization later in this exercise. You must wait until directory synchronization is activated. However, you can complete the following steps, even if you do see the warning message.

To the right of **Active Directory synchronization**, click **Manage** (or if Active Directory synchronization has not yet completed, click **Set up**).

Under **Install and configure the Directory Sync tool**, click **Download**.

In the Internet Explorer notification bar, click **Save**, click **Save as**, then browse to **C:\\Labfiles**, and click **Save**.

When the download has completed, in the Internet Explorer notification bar, click **Open folder**.

In File Explorer, right-click **dirsysnc.exe**, and then click **Run as administrator**.

In the **Windows Azure Active Directory Sync Setup** wizard, on the **Welcome** page, click **Next**.

On the **Microsoft Software License terms** page, click **I accept**, and click **Next**.

On the **Select Installation Folder** page, click **Next**.

**Note:** The installation process will take around 10 minutes to complete.

When the installation is complete, on the **Installation** page, click **Next**.

On the **Finished** page, clear the **Start Configuration Wizard now** check box, and click **Finish**.

####   Task 2: Install Windows Azure Active Directory Module for Windows PowerShell

1.  On **LUC-DC1**, press the Windows key to go to the Start screen.

On the Windows Start screen, click **Iucadmin**, and then click **Sign out**.

On the **LUC-CL1** virtual machine session, on the Desktop, on the Taskbar, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-DC1.rdp**, and connect as **LUCERNE\\LucAdmin**, password: **Pa$$w0rd**.

On **LUC-DC1**, press the Windows key, to go to the Start screen, and click **Computer**.

In File Explorer, in **C:\\Labfiles\\Lab10**, double-click **AdministrationConfig-EN**.

In the **Windows Azure Active Directory Module for Windows PowerShell Setup** wizard, on the **Welcome** page, click **Next**.

On the **License Terms** page, click **I accept the terms in the License Terms**, and click **Next**.

On the **Install Location** page, click **Next**.

On the **Ready to Install** page, click **Install**.

In the **User Account Control** dialog box, click **Yes**.

On the **Completing the Windows Azure Active Directory Module for Windows PowerShell Setup** page, click **Finish**.

####   Task 3: Configure DirSync

1.  On the Desktop, double-click **Directory Sync Configuration**.

In the **Windows Azure Active Directory Sync tool Configuration Wizard**, on the **Welcome** page, click **Next**.

On the **Windows Azure Active Directory Credentials** page, enter the following credentials, and click **Next**:

-   User name: **hleitner@labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number)

-   Password: **Pa$$w0rd**

On the **Active Directory Credentials** page, enter the following credentials, and then click **Next**:

> User name: **LUCERNE\\LucAdmin**
>
> Password: **Pa$$w0rd**

On the **Hybrid Deployment** page, *ensure that **Enable Hybrid Deployment** is NOT checked*, and click **Next**.

On the **Password Synchronization** page, *ensure that **Enable Password Sync** is NOT checked*, and click **Next**.

**Note:** You will set up password synchronization later in this lab.

When the configuration has completed, on the **Configuration** page, click **Next**.

On the **Finished** page, clear the **Synchronize your directories now** check box, and click **Finish**.

**Note:** You clear this check box because you are setting up OU filtering in the next step.

On the **Desktop**, on the **Taskbar**, click **File Explorer**.

Navigate to **C:\\Program Files\\Windows Azure Active Directory Sync\\SYNCBUS\\Synchronization Service\\UIShell**.

Double-click **miisclient.exe**.

In **Synchronization Service Manager**, click the **Management Agents** tab.

In the **Management Agents** tab, double-click **Active Directory Connector**.

In the **Properties** dialog box, click **Configure Directory Partitions**.

Click **Containers**.

**Note**: The credentials dialog box initially displays the MSOL\_\<id\> account; this account uses a randomly generated password, so administrators will not know it.

In the **Credentials** dialog box, enter the following credentials, and click **OK**:

> User name**: dirsync-admin**
>
> Password: **Pa$$w0rd**
>
> Domain: **LUCERNE**

In the **Select Containers** dialog box, clear the **root level** check box, then select only the **Accounts** and **Sales** check boxes, and then click **OK**.

In the **Properties** dialog box, click **Configure Connector Filter** and then in the **Data Source Object Type** grid, scroll down and select the **User** object.
**Note:** All filters defined for the User object will be displayed. Note the FIM accounts that are excluded from sync by default.

With **User** selected in the Data Source Object Type grid, click **New**.

In the **Filter for user** dialog box, in the **Data Source attribute** list, select **extensionAttribute15**, in the **Operator** list, select **Equals**, and then in the **Value** box, type **NoSync**.

Click **Add Condition**, and then click **OK** to close the **Filter for user** dialog box.

With **User** selected in the **Data Source Object Type** grid, click **New**.

In the **Filter for user** dialog box, in the **Data Source attribute** list, select **sAMAccountName**, in the **Operator** list, select **Starts with**, and then in the **Value** box, type **SM\_**.

Click **Add Condition**, and then click **OK**, to close the **Filter for user** dialog box.

Click **OK** to close the Properties dialog box.

In **Synchronization Service Manager**, on the **Management Agents** tab, right-click **Active Directory Connector**, and click **Export Management Agent**.

In the **Save As** dialog box, browse to **C:\\Labfiles**, and in the **File name** box, type **AD\_Connector**, and then click **Save**.

####   Task 4: Perform Initial Synchronization

1.  In **Synchronization Service Manager**, on the **Management Agents** tab, right-click **Active Directory Connector**, and click **Run**.

In the **Run Management Agent** dialog box, click **Full Import Full Sync**, and then click **OK**.

Right-click the **Windows Azure Active Directory Connector** and click **Run**.

In the **Run Management Agent** dialog box, click **Export**, and then click **OK**.

Press the Windows key to go to the Start screen.

On the Windows Start screen, double-click **Windows Azure Active Directory Module for Windows PowerShell.**

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Connect-MsolService

In the **Enter Credentials** dialog box, enter the following credentials, and click **OK**:

> User name: **hleitner@labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number)
>
> Password: **Pa$$w0rd**

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolCompanyInformation | fl LastDirSyncTime

On **LUC-DC1**, press the Windows key, to go to the Start screen.

On the Windows Start screen, click **Internet Explorer**.

In the **Address** box, type **http://portal.microsoftonline.com**, and press Enter.

On the **Sign** page, in the **Name** box, type **hleitner@labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number).

In the **Password** box, type **Pa$$w0rd**, and then click **Sign in**.

In the **Office 365 admin center**, in the left navigation, click **Users**, and then click **Active users.**

Verify that the message **Last synced less than an hour ago** is displayed.

In the **Active users** list, note that your on-premises accounts from the Accounts and Sales OUs now have a status of **Synced with Active Directory**.

In the **Active users** list, verify that your users from the Engineering OU have not been synced to Office 365.

In the **Active users** list, verify that your Office 365 users have a status of **In cloud**. These users should include:

-   The mail user account you created for yourself.

-   The Main Conference room.

-   The Main Conference room projector.

-   The Marketing Department group.

In **Server Manager**, click **Tools**, and then click **Active Directory Users and Computers**.

In **Active Directory Users and Computers**, open the **Users** OU, and verify that the Office 365 users from this OU have not been synchronized from the on-premises Active Directory to Office 365.

Open the **Engineering** OU and verify that these users have not been synchronized from the on-premises Active Directory to Office 365.

####   Task 5: Implement Password Synchronization

1.  On **LUC-DC1**, switch to the **Office 365 admin center** session in Internet Explorer logged in as **Heidi Leitner**.

In the **Active users** list, select the check box for **William Douglas**.

Under **Quick steps**, click **Reset passwords**.

On the **Send results in email** page, click **Reset password**.

On the **Results** page, note the temporary password here

Click **Finish**.

Switch to the **LUC-CL2** RDP session.

Press the Windows key to go to the Start screen.

On the Start screen, click **LucAdmin**, and then click **Sign out**.

On the **LUC-CL1** virtual machine session, on the Taskbar, click **File** **Explorer**.

Navigate to **E:\\RDP\_files**, double-click **LUC-CL2.rdp**, and connect as **LUCERNE\\** **wdouglas**, password: **Pa$$w0rd**.

On the Windows Start screen, click **Internet** **Explorer**.

If you get a **Windows Internet Explorer 10** dialog box, select **Use recommended security and compatibility settings**, and then click **OK**.

In the **Address** box, type **http://portal.microsoftonline.com**, and press Enter.

On the **Sign** page, in the **Name** box, type **wdouglas@labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number).

In the **Password** box, type the temporary password you noted above, and then click **Sign in**.

On the **Update password** page, in the **Old password** box, type the temporary password, and in the **New password** and **Confirm new password** boxes, type **N3wPa$$w0rd**, and then click **Save**.

On the **Office 365** page, in the **Password** box, type **N3wPa$$w0rd**, and then click **Sign in**.

Verify that you can sign in to Office 365 with your updated password.

On the **Getting started with Office 365** page, click **William Douglas**, and then click **Sign Out**.

Switch to the **LUC-DC1** session.

On **LUC-DC1**, on the **Desktop**, double-click **Directory Sync Configuration**.

In the **Windows Azure Active Directory Sync tool Configuration Wizard**, on the **Welcome** page, click **Next.**

On the **Windows Azure Active Directory Credentials** page, enter the following credentials, and click **Next**:

> User name: **hleitner@labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number)
>
> Password: **Pa$$w0rd**

On the **Active Directory Credentials** page, enter the following credentials, and then click **Next**:

> User name: **lucadmin@lucernepublishing.local**
>
> Password: **Pa$$w0rd**

On the **Hybrid Deployment** page, *ensure that **Enable Hybrid Deployment** is NOT checked*, and click **Next**.

On the **Password Synchronization** page, select the **Enable Password Sync** check box, and click **Next**.

When the configuration has completed, on the **Configuration** page, click **Next**.

On the **Finished** page, verify that the **Synchronize your directories now** check box is selected; select this check box if it is not checked by default. Click **Finish**.

On the **Windows Azure Active Directory Sync tool Configuration Wizard** dialog box, click **OK**.

####   Task 6: Verify Password Synchronization

1.  In **Server Manager**, click **Tools**, and then click **Event Viewer**.

In **Event Viewer**, in the console tree, expand **Windows Logs**, and then click **Application**.

Select **Directory Synchronization events, Event ID 656**.
**
Note:** This lists all password change requests for synchronized users.

Select **Directory Synchronization events, Event ID 657**.
**Note:** This lists all successful password change requests.

Switch to the **LUC-CL2** session.

In Internet Explorer, on the **Office 365 Sign** page, in the **Name** box, type **wdouglas@labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number), in the **Password** box, *type **N3wPa$$w0rd** (the Office 365 password you just set*), then click **Sign in**.

You will see a **We don't recognize this user ID or password** message. Enter **Pa$$w0rd** (the on-premises password), and then click **Sign in**.

Verify that you can sign in to Office 365 with the same password as is used for Active Directory on-premises.

On the **Getting started with Office 365** page, click **William Douglas**, and then click **Sign Out.**

**Results**: Lucerne Publishing has configured Directory Synchronization, migrated its users and groups into Office 365, and then enabled password synchronization.

### Exercise 3: Manage Active Directory users and groups with DirSync in place

Scenario

Now that DirSync and password sync are in place, Lucerne Publishing needs to modify its user and group management procedures so that all users and groups are created and edited in Active Directory. At that point, all additions, deletions, and updates will be synchronized to Office 365.

The main tasks for this exercise are as follows:

1. Add New Users in AD Using GUI Tools, and then Sync

2. Add New Users in AD Using PowerShell, then Sync and Activate

3. Modify AD Users and then Sync

4. Delete AD Users and then Sync

5. Set a User as NoSync and Verify Office 365 Removal

####   Task 1: Add New Users in AD Using GUI Tools, and then Sync

1.  On **LUC-EX1**, in **Server Manager**, click **Tools**, and then click **Active Directory Users and Computers**.

In the console tree, expand **lucernepublishing.local**, right-click **Sales**, point to **New**, and then click **User**.

In the **First** **name** box, type **Lynette**.

In the **Last** **name** box, type **Kelly**.

In the **User** **logon** **name** box, type **lkelly**, then select your lab domain UPN (***not** lucernepublishing.local*), and then click **Next**.

In the **Password** and **Confirm password** boxes, type **Pa$$w0rd**, clear the **User must change password at next logon** check box, select the **Password never expires** check box, click **Next**, and then click **Finish**.

In the **User** list, double-click **Lynette Kelly**.

In the **Properties** dialog box, in the **E-mail** box, type **lkelly@\<your lab domain UPN\>**, and click **OK**.

Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click the **LUC-DC1 RDP** session.

On the desktop, right-click the **Windows PowerShell** shortcut and click **Run as administrator**.
**Note:** This generic Windows PowerShell session is now configured as a **DirSyncConfigShell** session.

If a **User Account Control** dialog box appears, click **Yes**.

At the prompt, type the following command and press Enter:

Set-ExecutionPolicy Unrestricted

Press Enter again to confirm the operation.

At the prompt, type the following command and press Enter:

Import-Module DirSync

At the prompt, type the following command, and press Enter:

Start-OnlineCoexistenceSync

On **LUC-DC1**, switch to the **Office 365 Admin Center** session in Internet Explorer.

In the **Office 365 Admin Center**, in the left navigation, click **Users**, and then click **Active users**.

In the **Active users** list, verify that **Lynette Kelly** has a status of "**Synced with Active Directory**".

In the **Active users** list, select the check box for **Lynette Kelly.**

Note that under **Quick Steps** there is an option to **Activate synced users**, as DirSync does not automatically activate synced new accounts in Office 365. Click **Activate synced users**.

On the **Assign Licenses** page, select **Switzerland** and then click **Activate**.

On the **Results** page, note that the password has not been reset, as password synchronization is now in operation.

On the **Results** page, click **Finish**.

####   Task 2: Add New Users in AD Using PowerShell, then Sync and Activate

1.  On **LUC-DC1**, on the Desktop, on the Taskbar, click **File Explorer**.

Navigate to **C:\\Labfiles\\Lab10**.

Double-click **SalesUserNames.csv**.

In the **How do you want to open this type of file?** dialog box, click **Notepad**.

Note the new accounts that you will create, and then close Notepad.

Right-click **CreateUsers.ps1**, and click **Edit**.

In the **PowerShell ISE,** note the code you will use to create new accounts, especially UPN and email setting.

At the **Windows PowerShell** prompt, type the following command, and press Enter:

Set-ExecutionPolicy Unrestricted

At the **Execution Policy Change** dialog box, click **Yes**.

In the **PowerShell ISE,** on the toolbar, click **Run Script**.

At the first prompt, type **SalesUserNames.csv**, and press Enter.

At the second prompt, type **\<your lab upn\>** in the form **labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number), and press Enter.

Switch to the **Windows PowerShell** session used for the DirSync configuration on LUC-DC1.

At the **Windows PowerShell** prompt, type the following command, and press Enter:

Start-OnlineCoexistenceSync

Switch to the **Windows Azure Active Directory Module for Windows PowerShell** session.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolAccountSku

**Note**: If the number of **ConsumedUnits** is the same as the number of **ActiveUnits**, you will not be able to do the next step.

Note the sku details: for example, **LucernePublishingXXXX:ENTERPRISEPACK** (where XXXX is your unique Lucerne Publishing number).

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolUser

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolUser -Synchronized

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolUser -UnlicensedUsersOnly

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolUser -Search Wade

Verify that this user is listed.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolUser -Search Wade |Set-MsolUser -UsageLocation CH

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolUser -Search Wade | Set-MsolUserLicense -AddLicenses LucernePublishingXXXX:ENTERPRISEPACK

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolUser | Where-Object {$\_.isLicensed -eq "True"}

Verify that your new user is now licensed in Office 365.

####   Task 3: Modify AD Users and then Sync

1.  At the **Windows Azure Active Directory Module for Windows PowerShell** prompt, type the following command, and press Enter:

Get-MsolUser | ft DisplayName, Office, City, Title

Switch to **Active Directory Users and Computers**.

In the console tree, expand **lucernepublishing.local**, and click **Sales**.

In the **User** list, double-click **Lynette Kelly**.

In the **Properties** dialog box:

1.  On the **General** tab, type **Western Europe Sales** in the **Office** field, and then click **Apply.**

2.  On the **Address** tab, type **Paris** in the **City** field, and then click **Apply.**

3.  On the **Organization** tab, type **Sales Manager** in the **Job Title** field, and then click **OK.**

Switch to the **Windows PowerShell** session used for the **DirSync configuration** on **LUC-DC1**.

At the Windows PowerShell prompt, type the following command, and press Enter:

Start-OnlineCoexistenceSync

Switch to the **Windows Azure Active Directory Module for Windows PowerShell** session.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolUser | ft DisplayName, Office, City, Title

Verify that the new Office, City, and Title for Lynette Kelly are shown.

####   Task 4: Delete AD Users and then Sync

1.  At the **Windows Azure Active Directory Module for Windows PowerShell** prompt, type the following command, and press Enter:

Get-MsolAccountSku

Note the number of **ConsumedUnits**.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolUser -Search Lynette

Verify that the new user is listed.

Switch to **Active Directory Users and Computers**.

In the console tree, expand **lucernepublishing.local**, and click **Sales**.

In the **User** list, right-click **Lynette Kelly**, and then click **Delete**.

In the **Active Directory Domain Services** dialog box, click **Yes**.

Switch to the **Windows PowerShell** session used for the **DirSync configuration** on **LUC-DC1**.

At the Windows PowerShell prompt, type the following command, and press Enter:

Start-OnlineCoexistenceSync

Switch to the **Windows Azure Active Directory Module for Windows PowerShell** session.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolUser -Search Lynette

Verify that no user is listed.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolAccountSku

Note the number of **ConsumedUnits** is now one less than before.

####   Task 5: Set a User as NoSync and Verify Office 365 Removal

1.  At the **Windows Azure Active Directory Module for Windows PowerShell** prompt, type the following command, and press Enter:

Get-MsolUser -Search William

Verify that the user is listed.

On **LUC-DC1**, switch to **ADSI Edit**.

In **ADSI Edit**, in the navigation pane, expand **Default** **naming** **context**, then expand **DC=lucernepublishing,DC=local**, and then click **OU=Accounts**.

In the **Results** pane, right-click **William Douglas**, and then click **Properties**.

In the **Properties** dialog box, in the **Attributes** list, select **extensionAttribute15**, and then click **Edit**.

In the **Attribute Editor**, in the **Value** box, type **NoSync**, and click **OK**, to close the Attribute Editor.

Click **OK**, to close the Properties dialog box.

Switch to the **Windows PowerShell** session used for the **DirSync configuration** on **LUC-DC1**.

At the Windows PowerShell prompt, type the following command, and press Enter:

Start-OnlineCoexistenceSync -FullSync

At the **Windows Azure Active Directory Module for Windows PowerShell** prompt, type the following command, and press Enter:

Get-MsolUser -Search William

Verify that no user is listed.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

Get-MsolAccountSku

Note the number of **ConsumedUnits** is now one less than before.
