Module 11

Lab: Implementing Active Directory Federation Services
------------------------------------------------------

Scenario

With the DirSync deployment working well and password synchronization requiring users only to maintain one set of credentials to access Office 365, users have been relatively happy with the deployment of Office 365 and the number of calls to the helpdesk has decreased considerably. However, one area that is becoming increasingly problematic is the ability of users to find content across both the on-premises SharePoint implementation and SharePoint Online. Because it has become a pressing business need for Lucerne Publishing users to find documents company-wide, Justin Muller and Alain Richer have decided to install a hybrid SharePoint environment. During their analysis of the situation, they learn that Hybrid SharePoint with Enterprise Search requires Single Sign-On (SSO), and that AD FS is the most obvious choice for this SSO deployment.

Objectives

To provide students with practical experience in the planning, installation and management of Active Directory Federation Services for single sign-on.

Lab Setup

Estimated Time: 105 minutes

Virtual machine: 20346C-LUC-CL1

Username: **Student1**

Password: **Pa$$w0rd**

In all tasks, where you see references to lucernepublishingXXXX.onmicrosoft.com, replace the XXXX with the unique Lucerne Publishing number that you were assigned when you set up your Office 365 account in Module 1, Lab 1B, Exercise 2, Task 3, Step 5.

Where you see references to labXXXXX.o365ready.com, replace the XXXXX with the unique O365ready.com number you were assigned when you registered your IP address at www.o365ready.com in Module 2, Lab 2B, Exercise 1, Task 2, Step 6.

Where you see references to your public IP address, replace the your public IP address with the IP address you noted in Module 2, Lab 2B, Exercise 1, Task 2, Step 2.

### Exercise 1: Install AD FS Servers and Proxy Servers

Scenario

With the complexity of this deployment, Remi decides that he wants to be involved at a hands-on level. Heidi works with Elizabeth Labrecque to verify whether single-sign on is functioning properly, and then Remi makes the final configuration changes to switch the Office 365 domain across to federated. Finally, Elizabeth sees the different experience with AD FS.

The main tasks for this exercise are as follows:

1. Import 3rd Party Certificate on First AD FS Server

2. Verify UPNs for Accounts and Sales Users

3. Create Host Records for AD FS Services

4. Configure a Service Account for Federation Server Farm

5. Install the First Active Directory Federation Services in the Farm

6. Configure the First Active Directory Federation Services in the Farm

7. Import Third-party Certificate on Second AD FS Server

8. Install the Second Active Directory Federation Services in the Farm

9. Configure the Second Active Directory Federation Services in the Farm

10. Verify the Federation Server is Operational

11. Import Third-party Certificate on AD FS Proxy

12. Install and Configure Active Directory Federation Services Proxy Server

13. Verify the Federation Server Proxy is Operational

14. Verify the Pre-federation User/Client Experience

15. Create a New User Account for Domain Management

16. Convert a Managed Domain to a Federated Domain using Windows PowerShell

17. Verify Identity Federation and Internal Client Connectivity

18. Verify Client Connectivity Using AD FS Proxy

####   Task 1: Import 3rd Party Certificate on First AD FS Server

On your host computer, switch to the **20346C-LUC-CL1** virtual machine.

Ensure you are logged on as **Student1** with a password of **Pa$$word**.

On **LUC-CL1**, on the Desktop, on the Taskbar, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-SV1.rdp**, and connect as **LUCERNE\\LucAdmin**, password: **Pa$$w0rd**.

On **LUC-SV1**, on the Taskbar, click **File Explorer**.

Right-click **Local Disk (C:)**, click **New**, and then click **Folder**.

Type **Certificates**, and then press Enter.

Browse to **\\\\LUC-EX1\\C$\\Temp**, right-click **Labcert.pfx**, and click **Copy**.

On **LUC-SV1**, in **File Explorer**, browse to the **C:\\Certificates** folder that you just created and paste in the **LabCert.pfx** certificate.

In **C:\\Certificates**, double-click **LabCert.pfx**.

In the **Certificate Import Wizard**, on the **Welcome to the Certificate Import Wizard** page, select **Local Machine**, and click **Next**.

On the **File to Import** page, click **Next**.

On the **Private key protection** page, in the **Password** box, type **Pa$$w0rd**, and click **Next**.

On the **Certificate Store** page, click **Place all certificates in the following stores**, and click **Browse**.

In the **Select Certificate Store** dialog box, click **Personal**, and then click **OK**.

On the **Certificate Store** page, click **Next**.

On the **Completing the Certificate Import Wizard** page, click **Finish**.

If you get a **Security Warning** dialog box, click **Yes**.

In the **Certificate Import Wizard** dialog box, click **OK**.

####   Task 2: Verify UPNs for Accounts and Sales Users

1.  On **LUC-DC1**, in **Server Manager**, click **Tools**, and then click **Active Directory Domains and Trusts**.

In **Active Directory Domains and Trusts**, right-click **Active Directory Domains and Trusts [ LUC-DC1.lucernepublishing.local ]**, and then click **Properties**.

In **Active Directory Domains and Trusts [ LUC-DC1.lucernepublishing.local ] Properties**, verify that your lab domain, in the form **labXXXXX.o365ready.com** (where XXXXX is your unique O365ready.com number) is listed as a UPN suffix.

On the Taskbar, click **Windows PowerShell**.

At the Windows PowerShell prompt, type the following command, and press Enter:

**Get-ADForest**

Verify that your lab domain is listed as a UPN suffix.

####   Task 3: Create Host Records for AD FS Services

1.  On **LUC-DC1**, in **Server Manager**, click **Tools**, and then click **DNS**.

In **DNS Manager**, on the **View** menu, click **Advanced** to display the TTL value on records.

In **DNS Manager**, expand **LUC-DC1**, then expand **Forward Lookup Zones**.

Right-click **labXXXXX.o365ready.com** (where XXXXX is your unique O365ready.com number), and click **New Host (A or AAAA)**.

In the **New Host** dialog box, in the **Name** box, type **fs**, in the **IP address** box, type ***your public IP address*** (where "your public IP address" is the address you noted in Module 1, Lab 1A, Exercise 1), in the **Time to live (TTL)** box, change the value to **0:0:2:0** (two minutes), and then click **Add Host**.

**Note:** This is the external IP address of the AD FS Proxy server, and will be used by external clients to access the AD FS server through the AD FS Proxy.

**Important:** We are using a low TTL value for testing only; in a production environment, you would use a longer duration for the TTL.

In the **DNS** dialog box, click **OK**.

In the **New Host** dialog box, create another host record, name **fs**, with IP address: **10.0.0.6**; in the **Time to live (TTL)** box, ensure that the value is set to **0:0:2:0** (two minutes), and then click **Add Host**.

**Note:** This is the IP address of the **LUC-SV1** server where AD FS will be installed, and will be used by internal clients to directly access the AD FS server, bypassing the AD FS Proxy.

**Important:** We are using a low TTL value for testing only; in a production environment, you would use a longer duration for the TTL.

In the **DNS** dialog box, click **OK**.

In the **New** **Host** dialog box, click **Done**.

####   Task 4: Configure a Service Account for Federation Server Farm

1.  On **LUC-DC1**, in **Server Manager**, click **Tools**, and then click **Active Directory Users and Computers**.

In the console tree, expand **lucernepublishing.local**, right-click **Users**, point to **New**, and then click **User**.

In the **Full** **name** and **User** **logon** **name** boxes, type **adfs-service**, and then click **Next**.

In the **Password** and **Confirm password** boxes, type **Pa$$w0rd**, clear the **User must change password at next logon** check box, select the **Password never expires** check box, click **Next**, and then click **Finish**.

In the **Results** pane, right-click **adfs-service**, and then click **Properties**.

In **adfs-service Properties**, click the **Member Of** tab, and then click **Add**.

In the **Select Groups** dialog box, in the **Enter the object names to select** box, type **domain admins**, and then click **Check Names.**

Click **OK** to close the Select Groups dialog box.

Click **OK** to close the adfs-service Properties dialog box.

Switch to **Windows PowerShell**, which should still be open from an earlier task.

At the Windows PowerShell prompt, type the following command, and press Enter:

**setspn -a host/fs.LabXXXXX.o365ready.com adfs-service **

On **LUC-DC1**, at the Windows PowerShell prompt, type the following command, and press Enter:

**setspn -l adfs-service**

####   Task 5: Install the First Active Directory Federation Services in the Farm

1.  Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-SV1.rdp**, and connect as **LUCERNE\\LucAdmin**, password: **Pa$$w0rd**.

On **LUC-SV1**, in **Server Manager**, click **Manage**, and then click **Add Roles and Features**.

In the **Add Roles and Features Wizard**, on the **Before you begin** page, click **Next**.

On the **Select installation type** page, click **Role-based or Feature-based installation**, and click **Next**.

On the **Select destination server** page, click **Select a server from the server pool**, verify that the target computer is highlighted, and then click **Next**.

On the **Select server roles** page, click **Active Directory Federation Services**.

In the **Add Roles and Features Wizard** dialog box, click **Add Features** to install additional .NET Framework, IIS, and Windows Process Activation Service features.

On the **Select server roles** page, click **Next**.

On the **Select features** page, click **Next**.

On the **Active Directory Federation Service (AD FS)** page, click **Next**.

On the **Select role services** page, verify the **Federation Service** check box is selected; if it’s not, then select it now. Click **Next**.

On the **Web Server Role (IIS)** page, click **Next**.

On the **Select role services** page, click **Next**.

On the **Confirm installation selections** page, click **Install**.

When the installation is complete, on the **Installation progress** page, click **Close**.

In **Server Manager**, click **Tools**, and click **Internet Information Services (IIS) Manager**.

In **Internet Information Services (IIS) Manager**, expand **LUC-SV1**.

If you get an **Internet Information Services (IIS) Manager** dialog box, click **No**.

Expand **Sites**, and then click **Default Web Site**.

In the **Actions** pane, under **Edit Site**, click **Bindings**.

In the **Site Bindings** dialog box, click **Add**.

In the **Add Site Binding** dialog box, select **https** as **Type**.

In the **SSL certificate** list, select **Microsoft Exchange**, and then click **OK**.

In the **Site Bindings** dialog box, click **Close**, and then close IIS Manager.

####   Task 6: Configure the First Active Directory Federation Services in the Farm

1.  In **Server Manager**, click **Tools**, and then click **AD FS Management**.

In the **AD FS** console, click **AD FS Federation Server Configuration Wizard**.

In the **AD FS Federation Server Configuration Wizard**, on the **Welcome** page, verify that **Create a new Federation Service** is selected, and then click **Next**.

On the **Select Stand-Alone or Farm Deployment** page, click **New federation server farm**, and then click **Next**.

On the **Specify the Federation Service Name** page, verify that the **Microsoft Exchange** SSL certificate is displayed; if this is not the correct certificate, select the appropriate certificate from the SSL certificate list.

Click **Next**.

On the **Specify a Service Account** page, click **Browse**.

In the **Select User** dialog box, in the **Enter the object names to** **select** box, type **adfs-service**, and then click **Check Names**.

In the **Select User** dialog box, click **OK**.

On the **Specify a Service Account** page, in the **Password** box, type **Pa$$w0rd**, and then click **Next**.

On the **Ready to Apply Settings** page, review the details, and then click **Next**.

On the **Configuration Results** page, review the results; when all the configuration steps are finished, click **Close** to exit the wizard.

On the Start screen, type **PowerShell**.

Right-click **Windows PowerShell**, and then click **Run as administrator**.

At the Windows PowerShell prompt, type the following command, and press Enter

**Enable-PSRemoting –force**

####   Task 7: Import Third-party Certificate on Second AD FS Server

1.  Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-SV2.rdp**, and connect as **LUCERNE\\LucAdmin**, password: **Pa$$w0rd**.

On **LUC-SV2**, on the Taskbar, click **File Explorer**.

Right-click **Local Disk (C:)**, click **New**, and then click **Folder**.

Type **Certificates**, and then press Enter.

Browse to **\\\\LUC-EX1\\C$\\Temp**, right-click **LabCert.pfx**, and click **Copy**.

On **LUC-SV2**, in **File Explorer**, browse to the **C:\\Certificates** folder that you just created and paste in the **LabCert.pfx** certificate.

<span id="List_185" class="anchor"></span>In **C:\\ Certificates**, double-click **LabCert.pfx**.

In the **Certificate Import Wizard** page, on the **Welcome to the Certificate Import Wizard** page, select **Local Machine**, and click **Next**.

On the **File to Import** page, click **Next**.

On the **Private key protection** page, in the **Password** box, type **Pa$$w0rd**, and click **Next**.

On the **Certificate Store** page, click **Place all certificates in the following stores**, and click **Browse**.

In the **Select Certificate Store** dialog box, click **Personal**, and then click **OK**.

On the **Certificate Store** page, click **Next**.

On the **Completing the Certificate Import Wizard** page, click **Finish**.

If you get a **Security Warning** dialog box, click **Yes**.

In the **Certificate Import Wizard** dialog box, click **OK**.

####   Task 8: Install the Second Active Directory Federation Services in the Farm

1.  On **LUC-SV2**, in **Server Manager**, click **Manage**, and then click **Add Roles and Features**.

In the **Add Roles and Features Wizard**, on the **Before you begin** page, click **Next**.

On the **Select installation type** page, click **Role-based or Feature-based installation**, and click **Next**.

On the **Select destination server** page, click **Select a server from the server pool**, verify that the target computer is highlighted, and then click **Next**.

On the **Select server roles** page, click **Active Directory Federation Services**.

In the **Add Roles and Features Wizard** dialog box, click **Add Features** to install additional .NET Framework, IIS, and Windows Process Activation Service features.

On the **Select server roles** page, click **Next**.

On the **Select features** page, click **Next**.

On the **Active Directory Federation Service (AD FS)** page, click **Next**.

On the **Select role services** page, verify the **Federation Service** check box is selected; if it’s not, then select it now. Click **Next**.

On the **Web Server Role (IIS)** page, click **Next**.

On the **Select role services** page, click **Next**.

On the **Confirm installation selections** page, click **Install**.

When the installation is complete, on the **Installation progress** page, click **Close**.

On **LUC-SV2**, in **Server Manager**, click **Tools**, and then click **Internet Information Services (IIS) Manager**.

In **Internet Information Services (IIS) Manager**, expand **LUC-SV2**.

If you get an **Internet Information Services (IIS) Manager** dialog box, click **No**.

Expand **Sites**, and then click **Default Web Site**.

In the **Actions** pane, under **Edit Site**, click **Bindings**.

In the **Site Bindings** dialog box, click **Add**.

In the **Add Site Binding** dialog box, select **https** as the **Type**.

In the **SSL certificate** list, select **Microsoft Exchange**, and then click **OK**.

In the **Site Bindings** dialog box, click **Close**, and then close IIS Manager.

If you receive a connection error, close the error and restart these steps from Step 1, overwriting any existing settings.

####   Task 9: Configure the Second Active Directory Federation Services in the Farm

1.  On **LUC-SV2**, in **Server Manager**, click **Tools**, and then click **AD FS Management**.

In the **AD FS console**, click **AD FS Federation Server Configuration Wizard**.

In the **AD FS Federation Server Configuration Wizard**, on the **Welcome** page, click **Add a federation server to an existing Federation Service**, and then click **Next**.

On the **Specify the Primary Federation Server and Service Account** page, under **Primary federation server name**, type **LUC-SV1.lucernepublishing.local**, and then after the **Service account** box, click **Browse**.

In the **Select User** dialog box, in the **Enter the object names to select** box, type **adfs-service**, and then click **Check Names**.

In the **Select User** dialog box, click **OK**.

On the **Specify the Primary Federation Server and Service Account** page, in the **Password** box, type **Pa$$w0rd**, and then click **Next**.

On the **Specify the Federation Service Name** page, verify that the **Microsoft Exchange** SSL certificate is displayed; if this is not the correct certificate, select the appropriate certificate from the SSL certificate list.

Click **Next**.

On the **Ready to Apply Settings** page, review the details, and then click **Next**.

On the **Configuration Results** page, review the results. Note the information message about any website customizations needing to match on all sites in the farm.
**Note:** If you get a connection error, you must return to step 1 and re-run all the steps in this task

When all the configuration steps are finished, click **Close** to exit the wizard.

####   Task 10: Verify the Federation Server is Operational

1.  On **LUC-SV2**, in **Server Manager**, click **Tools**, and then click **Event Viewer**.

In the **Details** pane, expand **Applications and Services Logs**, then expand **AD FS**, and then click **Admin**.

In the **Event ID** column, look for event ID **100**.
**Note:** If the federation server is configured properly, you should see a new event with event ID 100 in the Application log of Event Viewer. This event verifies that the federation server was able to successfully communicate with the Federation Service.

Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-CL2.rdp**, and connect as **LUCERNE\\LucAdmin**, password: **Pa$$w0rd**.

On the Start screen, click **Internet Explorer**.

In Internet Explorer, in the address bar type **https://fs.LabXXXXX.O365Ready.com/adfs/fs/federationserverservice.asmx** (where XXXXX is your unique O365ready.com number), and then press Enter.

If you get a message stating **There is a problem with this website’s security certificate**, click **Continue to this website**.

On **LUC-CL2**, press the Windows key to go to the Start screen.

On Start screen, click **LucAdmin**, and then click **Sign out**.

If a **Remote Desktop Connection** dialog box appears, click **OK**.

####   Task 11: Import Third-party Certificate on AD FS Proxy

1.  Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-SV3.rdp**, and connect as **LUC-SV3\\LocalAdmin**, password: **Pa$$w0rd**.

On **LUC-SV3**, on the Taskbar, click **File Explorer**.

Right-click **Local Disk (C:)**, click **New**, and then click **Folder**.

Type **Certificates**, and then press Enter.

Browse to **\\\\10.0.0.5\\C$\\Temp**, right-click **LabCert.pfx**, and click **Copy**.

On **LUC-SV3**, in **File Explorer**, browse to the **C:\\Certificates** folder that you just created and paste in the **LabCert.pfx** certificate.

In **C:\\ Certificates**, double-click **LabCert.pfx**.

In the **Certificate Import Wizard**, on the **Welcome to the Certificate Import Wizard** page, select **Local Machine**, and click **Next**.

On the **File to Import** page, click **Next**.

On the **Private key protection** page, in the **Password** box, type **Pa$$w0rd**, and click **Next**.

On the **Certificate Store** page, click **Place all certificates in the following stores**, and click **Browse**.

In the **Select Certificate Store** dialog box, click **Personal**, and then click **OK**.

On the **Certificate Store** page, click **Next**.

On the **Completing the Certificate Import Wizard** page, click **Finish**.

If you get a **Security Warning** dialog box, click **Yes**.

In the **Certificate Import Wizard** dialog box, click **OK**.

####   Task 12: Install and Configure Active Directory Federation Services Proxy Server

1.  On **LUC-SV3**, in **Server Manager**, click **Manage**, and then click **Add Roles and Features**.

In the **Add Roles and Features Wizard**, on the **Before you begin** page, click **Next**.

On the **Select installation type** page, click **Role-based or Feature-based installation**, and click **Next**.

On the **Select destination server** page, click **Select a server from the server pool**, verify that the target computer is highlighted, and then click **Next**.

On the **Select server roles** page, click **Active Directory Federation Services**.

In the **Add Roles and Features Wizard** dialog box, click **Add Features**.

On the **Select server roles** page, click **Next**.

On the **Select features** page, click **Next**.

On the **Active Directory Federation Service (AD FS)** page, click **Next**.

On the **Select role services** page, clear the **Federation Service** check box, select the **Federation Service Proxy** check box, and then click **Next**.

On the **Web Server Role (IIS)** page, click **Next**.

On the **Select role services** page, click **Next**.

On the **Confirm installation selections** page, click **Install**.

When the installation is complete, on the **Installation progress** page, click **Close**.

On **LUC-SV3**, in **Server Manager**, click **Tools**, and then click **Internet Information Services (IIS) Manager**.

In **Internet Information Services (IIS) Manager**, expand **LUC-SV3**.

If you get an **Internet Information Services (IIS) Manager** dialog box, click **No**.

Expand **Sites**, and then click **Default Web Site**.

In the **Actions** pane, under **Edit Site**, click **Bindings**.

In the **Site Bindings** dialog box, click **Add**.

In the **Add Site Binding** dialog box, select **https** as the **Type**, in the **SSL certificate** list, select **Microsoft Exchange**, and then click **OK**.

In the **Site Bindings** dialog box, click **Close**, and then close **IIS Manager**.

On **LUC-SV3**, in **Server Manager**, click **Tools**, and then click **AD FS Federation Services Proxy Configuration Wizard**.

In the **AD FS Federation Services Proxy Configuration Wizard**, on the **Welcome** page, click **Next**.

On the **Specify Federation Service Name** page, verify that **fs.LabXXXXX.O365Ready.com** is displayed as the federation service name (where XXXXX is your unique O365ready.com number).

Click **Test Connection**, and verify that you can connect to the Federation Service, and then click **OK**.

On the **Specify Federation Service Name** page, click **Next**.

In the **Windows Security** dialog box, enter the following credentials, and click **OK**:

> User name: **LUCERNE\\adfs-service**
>
> Password: **Pa$$w0rd**

**Note**: These credentials are necessary to establish a trust between this federation server proxy and the Federation Service. By default, only the service account used by the Federation Service, or a member of the local BUILTIN\\Administrators group, can authorize a federation server proxy.

On the **Ready to Apply Settings** page, review the details, and then click **Next**.

On the **Configuration Results** page, review the results; when all the configuration steps are finished, click **Close** to exit the wizard.

Switch to the **LUC-CL1** virtual machine.

Switch to the **Windows Azure Active Directory Module for Windows PowerShell** session.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

**CD E:\\Labfiles\\Lab11**

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

**.\\ResetPortForwarding.ps1**

####   Task 13: Verify the Federation Server Proxy is Operational

1.  On **LUC-SV3**, in **Server Manager**, click **Tools**, and then click **Event Viewer**.

In the **Details** pane, expand **Applications and Services Logs**, expand **AD FS**, and then click **Admin**.

In the **Event ID** column, look for event ID **198**.
**Note:** If the federation server is configured properly, you should see a new event with event ID 198 in the Application log of Event Viewer. This event verifies that the federation server proxy service was started successfully and is now online.

####   Task 14: Verify the Pre-federation User/Client Experience

1.  Switch to the **LUC-CL1** virtual machine session.

On the **Desktop**, on the Taskbar, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-CL2.rdp**, and connect as **elabrecque@LabXXXXX.O365Ready.com** (where XXXXX is your unique O365ready.com number), and password: **Pa$$w0rd**.

Press the Start key and click **Internet** **Explorer**.

If the **Set up Internet Explorer** dialog box appears, click **Use recommended security and compatibility settings**, and click **OK**.

In the **Address** box, type **http://mail.office365.com**, and press Enter.

On the **Sign** page, in the **Name** box, type **elabrecque@LabXXXXX.O365Ready.com**, (where XXXXX is your unique O365ready.com number).

Click the **Password** box.

Review the **Office 365** page for **Elisabeth Labrecque** and then close Internet Explorer.

On **LUC-CL2**, press the Windows key to go to the Start screen.

On Start screen, click **Elisabeth Labrecque**, and then click **Sign out**.

If the **Remote Desktop Connection** dialog box appears, click **OK**.

####   Task 15: Create a New User Account for Domain Management

1.  On **LUC-DC1**, open Internet Explorer and connect to your Office 365 tenant (**https://portal.microsoftonline.com**) as **HLeitner@labXXXXX.o365ready.com** (where XXXXX is your unique O365ready.com number).

In the **Office 365 admin center**, in the left navigation, click **Domains,** select domain **labXXXXX.o365ready.com** (where XXXXX is your unique O365ready.com number), and then click **Manage DNS**.

Review the domain type information for the partially delegated domain. It should say:

-   DNS is managed outside Office 365

-   The domain is set up with the following purpose: ExchangeOnline and LyncOnline

-   Domain status: Active

Click **Back to Domain Manager**.

Click **Users** and then click **Active users**.

Click the **+** (Add) sign.

In the **Details** page, In **First name**, enter **Remi**.

In **Last name**, enter **Desforges**.

In **User name,** enter **rdesforges**.

Click **Create** and note the temporary password. Click **Close**.

Double-click on **Remi Desforges** and then click **Settings**.

In **Settings**, under **Assign role**, click **Yes,** and then select **Global Administrator**.

In the **Alternate email address** field, enter **user@alt.none**.

Click **Licenses** and ensure **Switzerland** is selected. Click **Save.**

Click the **Heidi Leitner** profile icon in the top right corner, and then click **Sign out**.

####   Task 16: Convert a Managed Domain to a Federated Domain using Windows PowerShell

1.  Log on as **rdesforges@lucernepublishingXXXX.onmicrosoft.com** (where XXXX is your unique Lucerne Publishing number) with the temporary password.

In the **Old password** box, enter the temporary password.

In the **New password** and **Confirm password** boxes, enter **Pa$$w0rd**.

Click **Save**.

Re-enter **Pa$$w0rd** to sign on.

If you get a Don't lose access to your account page, enter **551234** for the **Mobile phone number**, **user@alt.none** for the **Alternate email address**, and then click **Save and continue**.

On **LUC-DC1**, press the Windows key, to go to the Start screen.

On the Windows Start screen, click **Windows Azure Active Directory Module for Windows PowerShell**.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

**Set-ExecutionPolicy Unrestricted**

Press Enter to confirm the execution policy change.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

**$msolcred = Get-Credential**

In the **Windows PowerShell Credential** dialog box, enter the following credentials, and click **OK**:

> User name: **rdesforges@lucernepublishingXXXX.onmicrosoft.com** (where XXXX is your unique Lucerne Publishing number)
>
> Password: **Pa$$w0rd**

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

**Connect-MsolService -Credential $msolcred**

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

**Get-MsolDomain**

Verify that your lab domain, **labXXXXX.o365Ready.com** (where XXXXX is your unique O365ready.com number), is listed as **Verified** and **Managed**.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

**Set-MsolAdfsContext -Computer LUC-SV1.lucernepublishing.local**

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

**Convert-MsolDomainToFederated -DomainName LabXXXXX.O365Ready.com **

Verify that you get a **Successfully updated \<your lab domain\> domain** message.

At the Windows Azure Active Directory Module for Windows PowerShell prompt, type the following command, and press Enter:

**Get-MsolFederationProperty -DomainName LabXXXXX.O365Ready.com **

This command reports the status of the domain federation, and provides details of URLs and certificates.

Switch to the **Office 365 admin center**, logged on as **Remi Desforges**.

In the **Office 365 admin center**, in the left navigation, click **Domains**, select domain **labXXXXX.o365ready.com** (where XXXXX is your unique O365ready.com number), and then click **Manage DNS**.

Verify that under **DNS management**, the domain is now configured for single sign on.

####   Task 17: Verify Identity Federation and Internal Client Connectivity

1.  Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click **File Explorer**.

Navigate **to E:\\RDP\_files**.

Double-click **LUC-CL2.rdp**, and connect as **elabrecque@labXXXXX.o365ready.com** (where XXXXX is your unique O365ready.com number) with a password of **Pa$$w0rd**; you are using this computer to test internal connectivity, as it is domain-joined.

Press the Windows key to go to the Start screen, and click **Internet Explorer**.

In Internet Explorer, in the upper-right hand corner, click the **cogwheel** icon to open the **Tools** menu, and then click **Internet Options**.

In the **Internet Options** dialog box, click the **Security** tab, click **Local intranet**, and then click **Sites**.

In the **Local Intranet** dialog box, click **Advanced**.

Under **Add this website to the zone**, enter **\*.o365Ready.com**, then click **Add**.

Click **Close**, then click **OK** and click **OK** again.

In the **Address** box, type **http://portal.microsoftonline.com**, and press Enter.

On the **Sign** page, in the **Name** box, type **elabrecque@labXXXXX.o365ready.com** (where XXXXX is your unique O365ready.com number).

Click the **Password** box.
**Note:** Notice that clicking in the Password box takes you directly to the Office 365 page, without the need to enter the password again.

Review the **Office 365** page for **Elisabeth Labrecque** and then close Internet Explorer.

Press the Windows key and in the Start page, type **Outlook**.

Click **Outlook 2013**.

In the **Welcome to Outlook 2013** page, click **Next**.

In the **Add an Email Account** page, click **Next**.

In **Auto Account** setup, ensure that **elabrecque@labXXXXX.o365ready.com** (where XXXXX is your unique O365ready.com number) is the **email address** and click **Next**, enter **Pa$$w0rd** as the **Password** for **elabrecque**, and then click **Finish**.

Verify that Outlook has successfully configured email for **Elisabeth Labrecque**.

####   Task 18: Verify Client Connectivity Using AD FS Proxy

1.  Switch to the **LUC-CL1** virtual machine session.
    **Note:** This computer is not domain-joined, so you are using this to simulate external access through the AD FS Proxy.

Press the Windows key to go to the Start screen.

Click **Internet Explorer**, and in the **Address** box, type **http://mail.office365.com**, and press Enter.

On the **Sign** page, in the **Name** box, type **elabrecque@labXXXXX.o365Ready.com** (where XXXXX is your unique O365ready.com number).

Click the **Password** box.

On the **ADFS Proxy** page, on the **Sign In at fs.LabXXXXX.o365Ready.com** page (where XXXXX is your unique O365ready.com number), in the **User name** box, type **elabrecque@labXXXXX.o365Ready.com** (where XXXXX is your unique O365ready.com number), in the **Password** box, type **Pa$$w0rd**, and click **Sign In**.

**Note:** This is the out-of-the-box sign-in page; you would customize this page with your company branding and logos.

On the **Outlook Web App** page, select your **time zone**, and click **Save**.

Review the **Office 365** page for **Elisabeth Labrecque** and then close Internet Explorer.

Note the experience from an external public computer, through the AD FS Proxy.

**Results**: At end of this process, Lucerne Publishing will have an AD FS farm installed and running correctly, with the AD FS proxy connected to AD FS farm, and users authenticating to Office 365 services with their on-premises user name and password.

### Exercise 2: Manage AD FS Servers and Proxy Servers

Scenario

Heidi wants to verify that she can perform administrative tasks in AD FS, such as renewing certificates, updating federation metadata, changing the primary AD FS server to the secondary and back again, and viewing the AD FS Proxy configuration through PowerShell.

The main tasks for this exercise are as follows:

1. View Certificate Expiry Dates

2. Install the Microsoft Office 365 Federation Metadata Update Tool

3. Switch the Primary AD FS Server in the Farm

4. Use Windows PowerShell to View AD FS Proxy Configuration

####   Task 1: View Certificate Expiry Dates

1.  Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click the **LUC-SV2 RDP** session.

On **LUC-SV2**, in **Server Manager**, click **Tools**, and then click **AD FS Management**.

Note the message that all configuration must be done from the primary federation server computer.

Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click the **LUC-SV1 RDP** session.

In the **AD FS console**, in the console tree, expand **Service**, and then click **Certificates**.

Note the expiry dates for service communications, token-decrypting, and token-signing certificates.

####   Task 2: Install the Microsoft Office 365 Federation Metadata Update Tool

1.  On the Taskbar, click **Windows PowerShell**.

At the Windows PowerShell prompt, type the following command, and press Enter:

**Set-ExecutionPolicy Unrestricted**

Press Enter to confirm the execution policy change.

At the Windows PowerShell prompt, type the following command, and press Enter:

**Add-WindowsFeature NET-Framework-Core -Source C:\\Windows\\WinSxS**

Point your mouse to the bottom right hand corner to bring up the **Charms menu**, then click **Settings**, click **Power**, click **Restart** and click **Continue**.

Wait a few minutes, and then on **LUC-CL1**, on the **Desktop**, on the **Taskbar**, click **File Explorer**.

Navigate to **E:\\RDP\_files**.

Double-click **LUC-SV1.rdp**, and connect as **LUCERNE\\LucAdmin**, password: **Pa$$w0rd**.

On **LUC-SV1**, on the Taskbar, click **File Explorer**, and then navigate to **\\\\LUC-DC1\\C$\\Labfiles\\Lab11**.

In **\\\\LUC-DC1\\C$\\Labfiles\\Lab11**, double-click **msoidcli\_64**.

In the **Microsoft Online Services Sign-in Assistant Setup** wizard, on the **License Terms** page, click **I accept the terms in the License Agreement and Privacy Statement**, and click **Install**.

On the **Completed the Microsoft Online Services Sign-in Assistant Setup Wizard** page, click **Finish.**

In **File Explorer**, navigate to **\\\\LUC-DC1\\C$\\Labfiles\\Lab11** and double-click **AdministrationConfig-EN.msi**.

**WARNING:** If you receive an error stating that .NET Framework 3.5 SP1 is not installed, restart LUC-SV1 and try step 10 again.

In the **Windows Azure Active Directory Module for Windows PowerShell Setup** wizard, on the **Welcome** page, click **Next**.

On the **License Terms** page, click **I accept the terms in the License Terms**, and click **Next**.

On the **Install Location** page, click **Next**.

On the **Ready to Install** page, click **Install**.

On the **Completing the Windows Azure Active Directory Module for Windows PowerShell Setup** page, click **Finish.**

On the Taskbar, click **File Explorer**, and then navigate to **\\\\LUC-DC1\\C$\\Labfiles\\Lab11**.

In **\\\\LUC-DC1\\C$\\Labfiles\\Lab11**, right-click **O365-Fed-MetaData-Update-Task-Installation.ps1**, and then click **Copy**.

Right-click **C:**, and click **New**, and then click **Folder**.

Type **Labfiles**, and then press Enter.

Open **C:\\Labfiles** and paste the **O365-Fed-MetaData-Update-Task-Installation.ps1** script file.

On the Taskbar, click **Windows PowerShell**.

At the Windows PowerShell prompt, type the following command, and press Enter:

**CD C:\\Labfiles**

At the Windows PowerShell prompt, type the following command, and press Enter:

**.\\O365-Fed-MetaData-Update-Task-Installation.ps1**

If you get a security warning, type **R**, and then press Enter.

At the **MSOL username** prompt, type **hleitner@labXXXXX.o365ready.com** (where XXXXX is your unique o365ready.com number), and press Enter.

At the **MSOL password** prompt, type **Pa$$w0rd**, and press Enter.

At the **LUCERNE\\LucAdmin password** prompt, type **Pa$$w0rd**, and press Enter.

Switch to **File Explorer**, and navigate to **C:\\Office365-Scripts**.

Verify that there is a new script: **Microsoft-Office365-Update-MSOLFederatedDomain.ps1.**

In **Server Manager**, from the **Tools** menu, click **Task Scheduler**.

In **Task Scheduler**, under **Active Tasks**, note that **Microsoft-Office365-Update-MSOLFederatedDomain.ps1** is scheduled to run every day at 12:00 AM.

####   Task 3: Switch the Primary AD FS Server in the Farm

1.  Switch back to the **Windows PowerShell** prompt and type the following command, then press Enter:

**Get-AdfsSyncProperties**

Verify that this server has the **PrimaryComputer** role.

On **LUC-SV2**, on the Taskbar, click **Windows PowerShell**.

At the Windows PowerShell prompt, type the following command, and press Enter:

**Get-AdfsSyncProperties**

Verify that this server has the **SecondaryComputer** role, and note the last sync status.

At the Windows PowerShell prompt, type the following command, and press Enter:

**Set-AdfsSyncProperties -Role PrimaryComputer**

Switch to the **LUC-SV1 RDP session**, and at the Windows PowerShell prompt, type the following command, and press Enter:

**Set-AdfsSyncProperties -Role SecondaryComputer -PrimaryComputerName LUC-SV2**

At the Windows PowerShell prompt, type the following command, and press Enter:

**Get-AdfsSyncProperties**

Verify that this server now has the **SecondaryComputer** role, and note the last sync status.

On **LUC-SV2**, at the Windows PowerShell prompt, type the following command, and press Enter:

**Get-AdfsSyncProperties**

Verify that this server now has the **PrimaryComputer** role.

####   Task 4: Use Windows PowerShell to View AD FS Proxy Configuration

1.  Switch to the **LUC-CL1** virtual machine session.

On the Desktop, on the Taskbar, click the **LUC-SV3 RDP** session.

**Note:** There is no Microsoft Management Console (MMC) snap-in to use for administering a federation server proxy. To configure and view settings for the federation server proxy you can either use Windows PowerShell cmdlets or rerun the AD FS Federation Services Proxy Configuration Wizard. For the purposes of this lab, we will use Windows PowerShell.

On **LUC-SV3**, on the Taskbar, click **Windows PowerShell**.

At the Windows PowerShell prompt, type the following command, and press Enter:

**Get-ADFSProxyProperties**

Verify the host name and ports used by the AD FS Proxy. The host name should be **fs.labXXXXX.o365ready.com** (where XXXXX is your unique O365ready.com number) and it should use the standard **https (443)** and **http (80)** ports.

**Results**: At end of this exercise, Lucerne Publishing has updated its AD FS certificates, and managed the AD FS environment successfully.
